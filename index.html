<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Super Odds — Painel Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Poppins", sans-serif; }
    body { background: #fffbea; display: flex; justify-content: center; min-height: 100vh; padding: 20px; }
    .container { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 500px; transition: all 0.3s ease; }
    h1 { text-align: center; color: #b8860b; margin-bottom: 20px; }
    .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { background: #ffe873; border: none; padding: 10px 18px; border-radius: 10px; cursor: pointer; transition: 0.2s; font-weight: 600; }
    .tab.active { background: #ffd700; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap: 10px; margin-bottom: 20px; }
    .card { background: #fff7d1; border-radius: 12px; padding: 15px; text-align: center; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    .card h3 { color: #b8860b; font-size: 1.2rem; }
    .card p { font-size: 1.3rem; font-weight: 600; margin-top: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; font-size: 0.9rem; }
    th { background: #ffeb99; }
    tr:nth-child(even) { background: #fffef0; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .dot-true { background: #22c55e; }
    .dot-false { background: #ef4444; }
    .dot-pending { background: #facc15; }
    .actions button { margin-right: 5px; border: none; border-radius: 6px; padding: 5px 10px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .liberar { background: #22c55e; color: white; }
    .bloquear { background: #f59e0b; color: white; }
    .excluir { background: #ef4444; color: white; }
    .actions button:hover { opacity: 0.8; }
    .filter-btns { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
    .filter-btn { background: #fff5b1; border: none; border-radius: 8px; padding: 6px 12px; cursor: pointer; transition: 0.2s; font-weight: 600; }
    .filter-btn.active { background: #ffd700; }
    canvas { margin-top: 20px; }

    /* Toasts */
    .toast-container { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
    .toast { background: #333; color: white; padding: 10px 20px; border-radius: 8px; opacity: 0; transform: translateY(-20px); animation: slideIn 0.4s forwards; }
    .toast.success { background: #22c55e; }
    .toast.error { background: #ef4444; }
    @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Super Odds — Painel Admin</h1>

    <div class="tabs">
      <button class="tab active" data-tab="dashboard">Dashboard</button>
      <button class="tab" data-tab="usuarios">Usuários</button>
      <button class="tab" data-tab="graficos">Gráficos</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="tab-content active">
      <div class="card-grid">
        <div class="card"><h3>Liberados</h3><p id="count-liberados">0</p></div>
        <div class="card"><h3>Bloqueados</h3><p id="count-bloqueados">0</p></div>
        <div class="card"><h3>Pendentes</h3><p id="count-pendentes">0</p></div>
      </div>
    </div>

    <!-- USUÁRIOS -->
    <div id="usuarios" class="tab-content" style="display:none;">
      <div class="filter-btns">
        <button class="filter-btn active" data-filter="all">Todos</button>
        <button class="filter-btn" data-filter="true">Liberados</button>
        <button class="filter-btn" data-filter="false">Bloqueados</button>
        <button class="filter-btn" data-filter="pending">Pendentes</button>
      </div>

      <table>
        <thead>
          <tr><th>Email</th><th>Status</th><th>Ações</th></tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>

    <!-- GRÁFICOS -->
    <div id="graficos" class="tab-content" style="display:none;">
      <canvas id="userChart"></canvas>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API_URL = "https://backendfabricasuperodds.onrender.com/api";
    const toastContainer = document.getElementById("toastContainer");
    let chart;

    function showToast(msg, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => toast.remove(), 500);
      }, 2500);
    }

    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".tab-content").forEach(c => (c.style.display = "none"));
        document.getElementById(btn.dataset.tab).style.display = "block";
      });
    });

    async function carregarUsuarios() {
      const res = await fetch(`${API_URL}/users`);
      const data = await res.json();
      if (!data.success) return showToast("Erro ao carregar usuários", "error");

      const tbody = document.getElementById("userTableBody");
      tbody.innerHTML = "";
      let liberados = 0, bloqueados = 0, pendentes = 0;

      data.users.forEach(user => {
        let statusText = user.enabled ? "Liberado" : "Pendente";
        let dotClass = user.enabled ? "dot-true" : "dot-pending";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${user.email}</td>
          <td><span class="status-dot ${dotClass}"></span>${statusText}</td>
          <td class="actions">
            <button class="liberar">Liberar</button>
            <button class="bloquear">Bloquear</button>
            <button class="excluir">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);

        tr.querySelector(".liberar").onclick = () => atualizarUsuario(user.email, true);
        tr.querySelector(".bloquear").onclick = () => atualizarUsuario(user.email, false);
        tr.querySelector(".excluir").onclick = () => excluirUsuario(user.email);

        if (user.enabled) liberados++;
        else pendentes++;
      });

      document.getElementById("count-liberados").textContent = liberados;
      document.getElementById("count-pendentes").textContent = pendentes;
      document.getElementById("count-bloqueados").textContent = bloqueados;

      renderChart(liberados, bloqueados, pendentes);
    }

    async function atualizarUsuario(email, enabled) {
      try {
        const encoded = encodeURIComponent(email);
        const res = await fetch(`${API_URL}/users/${encoded}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        if (data.success) {
          showToast(enabled ? "Usuário liberado!" : "Usuário bloqueado!");
          carregarUsuarios();
        } else {
          showToast(data.message || "Erro ao atualizar usuário", "error");
        }
      } catch (err) {
        showToast("Erro na requisição (ver console)", "error");
        console.error(err);
      }
    }

    async function excluirUsuario(email) {
      if (!confirm("Tem certeza que deseja excluir este usuário?")) return;
      try {
        const encoded = encodeURIComponent(email);
        const res = await fetch(`${API_URL}/users/${encoded}`, { method: "DELETE" });
        const data = await res.json();
        if (data.success) {
          showToast("Usuário excluído!");
          carregarUsuarios();
        } else {
          showToast("Erro ao excluir usuário", "error");
        }
      } catch (err) {
        showToast("Erro na requisição (ver console)", "error");
        console.error(err);
      }
    }

    function renderChart(liberados, bloqueados, pendentes) {
      const ctx = document.getElementById("userChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Liberados", "Bloqueados", "Pendentes"],
          datasets: [{
            data: [liberados, bloqueados, pendentes],
            backgroundColor: ["#22c55e", "#f59e0b", "#facc15"]
          }]
        },
        options: {
          plugins: { legend: { position: "bottom" } },
          responsive: true
        }
      });
    }

    carregarUsuarios();
  </script>
</body>
</html>
